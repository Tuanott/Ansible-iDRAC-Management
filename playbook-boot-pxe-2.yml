---
- name: Update all server attributes, Update FW, Change boot to PXE, Install OS
  hosts: r640-1
  gather_facts: false
  connection: local

  vars:
    bootdevice: "Pxe"
    scp_components: "ALL"
    share_name: "10.6.28.32:/nfs/ServerConfig"
    share_user: "share_user_name"
    share_password: "share_user_password"

  tasks:

    - name: Import Server Configuration Profile from a network share
      dellemc.openmanage.idrac_server_config_profile:
        idrac_ip: "{{ baseuri }}"
        idrac_user: "{{ username }}"
        idrac_password: "{{ password }}"
        command: "import"
        share_name: "{{ share_name }}"
        share_user: "{{ share_user }}"
        share_password: "{{ share_password }}"
        scp_file: "{{ scp_file }}"
        scp_components: "{{ scp_components }}"
        job_wait: true

    - name: Change boot order to put newly created RAID volume first
      dellemc.openmanage.idrac_server_config_profile:
        idrac_ip: "{{ baseuri }}"
        idrac_user: "{{ username }}"
        idrac_password: "{{ password }}"
        command: "import"
        share_name: "{{ share_name }}"
        share_user: "{{ share_user }}"
        share_password: "{{ share_password }}"
        scp_file: "{{ bootorder }}"
        scp_components: "{{ scp_components }}"
        job_wait: true

    - name: Set one-time boot device to {{ bootdevice }}
      community.general.redfish_command:
        category: Systems
        command: SetOneTimeBoot
        bootdevice: "{{ bootdevice }}"
        baseuri: "{{ baseuri }}"
        username: "{{ username }}"
        password: "{{ password }}"

    - name: Reboot system power gracefully
      community.general.redfish_command:
        category: Systems
        command: PowerGracefulRestart
        baseuri: "{{ baseuri }}"
        username: "{{ username }}"
        password: "{{ password }}"

